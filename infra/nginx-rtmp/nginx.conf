# Nginx RTMP + HLS ABR config (dew-streaming-service)
# Hooks point to dew-streaming-service container on :8787 with shared secret 'changeme'

worker_processes auto;

events {}

rtmp {
    server {
        listen 1935; # RTMP ingest
        chunk_size 4096;

        application live {
            live on;
            record off;

            # Authorize incoming streams and track lifecycle
            on_publish http://dew-streaming-service:8787/api/webhooks/publish?secret=changeme;
            on_publish_done http://dew-streaming-service:8787/api/webhooks/publish_done?secret=changeme;

            # Transcode to ABR HLS (1080p + 720p) and write to /var/www/hls/$name
            # ffmpeg exits when RTMP input ends
            exec push /bin/sh -c '
              mkdir -p /var/www/hls/$name && \
              ffmpeg -y -hide_banner -loglevel error -threads 2 \
                -i rtmp://127.0.0.1/live/$name \
                -filter_complex "[v:0]split=2[v1080][v720]; \
                                  [v1080]scale=w=1920:h=1080:flags=bicubic[v1080out]; \
                                  [v720]scale=w=1280:h=720:flags=bicubic[v720out]" \
                -map "[v1080out]" -map a:0? -c:v:0 libx264 -preset veryfast \
                -x264-params "keyint=60:min-keyint=60:scenecut=0" -b:v:0 4500k -maxrate:v:0 5350k -bufsize:v:0 9000k \
                -profile:v:0 high -c:a:0 aac -ar 48000 -b:a:0 128k \
                -map "[v720out]" -map a:0? -c:v:1 libx264 -preset veryfast \
                -x264-params "keyint=60:min-keyint=60:scenecut=0" -b:v:1 2500k -maxrate:v:1 3210k -bufsize:v:1 5000k \
                -profile:v:1 high -c:a:1 aac -ar 48000 -b:a:1 128k \
                -f hls -hls_time 5 -hls_list_size 6 -hls_flags delete_segments+independent_segments \
                -master_pl_name index.m3u8 \
                -var_stream_map "v:0,a:0 v:1,a:1" \
                -hls_segment_filename "/var/www/hls/$name/%v/seg_%06d.ts" \
                "/var/www/hls/$name/%v/index.m3u8" 
            ';
        }
    }
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen 8080; # HTTP HLS serving

        # CORS (adjust as needed)
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
        add_header 'Access-Control-Allow-Headers' 'Range,Origin,Accept,Content-Type,User-Agent' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Serve HLS playlists and segments
        location /hls/ {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /var/www;
            add_header Cache-Control no-cache; # consider tuning for CDN
        }

        location /health {
            return 200 'OK\n';
            add_header Content-Type text/plain;
        }
    }
}
